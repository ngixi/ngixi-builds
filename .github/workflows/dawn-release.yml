name: Release Dawn Binaries

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    uses: ./.github/workflows/dawn-build.windows.yml

  release:
    runs-on: lin-build
    needs: build-windows
    steps:
      - name: Checkout ngixi-builds repo
        uses: actions/checkout@v4
        with:
          clean: true

      - uses: ./.github/actions/setup-build
        with:
          build-dir: dawn-build

      - name: Download Dawn artifacts
        uses: actions/download-artifact@v4
        with:
          name: dawn-windows-assets

      - name: List downloaded files
        shell: bash
        run: |
          pwd
          ls -la
          find . -name "*.tar.gz"

      - name: Create build.zig.zon
        shell: pwsh
        run: |
          $tag = "${{ vars.DAWN_TAG }}"
          # Parse tag, e.g., if "v20251026.130842", version = "2025.10.26"
          if ($tag -match "v(\d{4})(\d{2})(\d{2})\.\d+") {
            $version = "$($matches[1]).$($matches[2]).$($matches[3])"
          } else {
            Write-Error "Unrecognized DAWN_TAG format: $tag"
            exit 1
          }
          $content = ".{`n    .name = `"dawn`",`n    .version = `"$version`",`n    .paths = .{`"`"},`n}"
          Set-Content -Path "build.zig.zon" -Value $content -Force

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: dawn-${{ vars.DAWN_TAG }}
          name: Dawn ${{ vars.DAWN_TAG }}
          files: |
            dawn_shared_win_x86_64.tar.gz
            build.zig.zon
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
