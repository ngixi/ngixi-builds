name: Build Assets

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-wasmtime:
    uses: ./.github/workflows/build-wasmtime-windows.yml

  build-zig-win32-bindings:
    uses: ./.github/workflows/build-zig-win32.yml
    needs: build-wasmtime

  build-dawn:
    uses: ./.github/workflows/build-dawn-windows.yml
    needs: build-zig-win32-bindings

  assemble-and-release:
    runs-on: ubuntu-latest
    needs: build-dawn
    permissions:
      contents: write

    steps:
      - name: Checkout ngixi-builds repo
        uses: actions/checkout@v4
        with:
          clean: false        

      - name: Download Dawn assets
        uses: actions/download-artifact@v4
        with:
          name: dawn-windows-assets
          path: all_assets_windows/dawn

      - name: Download Wasmtime assets
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: wasmtime-windows-assets
          path: all_assets_windows/wasmtime

      - name: Download Zig Win32 bindings assets
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: zig-win32-bindings-windows-assets
          path: all_assets_windows/zig-win32-bindings

      - name: Copy metadata files
        shell: bash
        run: |
          cp all_assets_windows/dawn/DAWN_GIT.txt . 2>/dev/null || true
          cp all_assets_windows/dawn/DEPENDENTS.txt . 2>/dev/null || true

      - name: Zip assets
        shell: bash
        run: |
          cd all_assets_windows
          zip -r ../all_assets_windows.zip .
          cd ..
          sha256sum all_assets_windows.zip > SHA256SUMS

      - name: Create Release and upload assets
        uses: softprops/action-gh-release@v2
        continue-on-error: true
        with:
          tag_name: ngixi-assets-${{ vars.NGIXI_ASSET_VERSION }}
          target_commitish: ${{ github.sha }}
          name: NGIXI Assets ${{ vars.NGIXI_ASSET_VERSION }} (Dawn ${{ vars.DAWN_TAG }})
          body: |
            NGIXI Assets v${{ vars.NGIXI_ASSET_VERSION }}
            Dawn: ${{ vars.DAWN_TAG }}
            Wasmtime: TODO
            Zig Win32 Bindings: ${{ vars.ZIGGEN_TAG }}

            Assets are a mix of various build outputs which ngixi knows how to consume (or will).
          files: |
            all_assets_windows.zip
            SHA256SUMS
            DAWN_GIT.txt
            DEPENDENTS.txt
          fail_on_unmatched_files: true