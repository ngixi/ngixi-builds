name: Build Zig Win32 Bindings

on:
  workflow_dispatch:
  workflow_call:

jobs:
  setup:
    runs-on: WIN-BUILD
    steps:
      - name: Checkout ngixi-builds repo
        uses: actions/checkout@v4
        with:
          clean: false

      - uses: ./.github/actions/setup-windows-build
        with:
          build-dir: zig-win32-build

  build-windows:
    runs-on: WIN-BUILD
    needs: setup
    defaults:
      run:
        working-directory: zig-win32-build

    steps:

      - name: Clone ZigWin32Gen
        shell: pwsh
        run: |
          if (-not (Test-Path zigwin32gen)) {
            git clone ${{ vars.ZIGGEN_REPO }} zigwin32gen
          }

      - name: Configure Git for ZigWin32Gen
        shell: pwsh
        run: |
          git config --global --add safe.directory "$PWD\zigwin32gen"

      - name: Checkout ZigWin32Gen tag
        shell: pwsh
        run: |
          cd zigwin32gen
          git fetch --tags --force --quiet
          git checkout --quiet ${{ vars.ZIGGEN_TAG }}
          git rev-parse --short HEAD | Out-File -Encoding ascii ..\ZIG_WIN32_GIT.txt

      - name: Build ZigWin32Gen
        shell: pwsh
        run: |
          cd zigwin32gen
          zig build

      - name: Generate Zig Win32 bindings
        shell: pwsh
        run: |
          cd zigwin32gen
          # Generate all Windows API bindings
          .\zig-out\bin\zigwin32gen.exe > ..\zig-win32-bindings.zig

      - name: Prepare Zig Win32 bindings assets
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path zig-win32-bindings-assets -Force
          # Copy the generated bindings
          Copy-Item zig-win32-bindings.zig zig-win32-bindings-assets/
          # Add version info
          Copy-Item ZIG_WIN32_GIT.txt zig-win32-bindings-assets/

      - name: Upload Zig bindings artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zig-win32-bindings-windows-assets
          path: zig-win32-build/zig-win32-bindings-assets/